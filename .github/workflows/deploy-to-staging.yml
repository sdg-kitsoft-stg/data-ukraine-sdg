# ****************************************************************************
# Deploy OpenSDG DATA to staging (GitHub Pages)
#
# This workflow:
# - builds OpenSDG data into _site/
# - adds required /en/ language namespace (latest OpenSDG requirement)
# - deploys data to gh-pages
# - triggers site rebuild
# ****************************************************************************

name: Deploy to staging

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Python
      # ------------------------------------------------------------
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # ------------------------------------------------------------
      # Build data (outputs to _site/)
      # ------------------------------------------------------------
      - name: Build data
        run: |
          python scripts/build_data.py

      # ------------------------------------------------------------
      # Add language namespace (/en)
      # ------------------------------------------------------------
      - name: Add language namespace
        run: |
          set -e

          echo "Checking build output..."
          if [ ! -d _site/meta ]; then
            echo "ERROR: _site/meta not found"
            echo "Directory listing:"
            ls -la
            exit 1
          fi

          echo "Adding /en namespace..."
          mkdir -p _site/en
          rm -rf _site/en/meta _site/en/data _site/en/indicator-config

          cp -r _site/meta _site/en/
          cp -r _site/data _site/en/
          cp -r _site/indicator-config _site/en/

      # ------------------------------------------------------------
      # Deploy DATA to GitHub Pages
      # ------------------------------------------------------------
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: _site
          CLEAN: true

      # ------------------------------------------------------------
      # Wait for Pages propagation (GitHub latency)
      # ------------------------------------------------------------
      - name: Wait for Pages deployment
        run: |
          sleep 240

      # ------------------------------------------------------------
      # Trigger SITE rebuild (site-ukraine-sdg)
      # ------------------------------------------------------------
      - name: Trigger site rebuild
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/STAGING_ORGANISATION/STAGING_SITE_REPOSITORY/actions/workflows/deploy-to-staging.yml/dispatches \
            -d '{"ref":"main"}'
